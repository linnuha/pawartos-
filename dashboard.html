<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Penduduk</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <h3 class="mb-3">ðŸ“Š Data Penduduk</h3>
  <div id="adminActions" class="mb-3" style="display:none;">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#formModal">+ Tambah Penduduk</button>
  </div>
  
  <table class="table table-bordered" id="tablePenduduk">
    <thead class="table-dark">
      <tr>
        <th>Nama</th>
        <th>NIK</th>
        <th>Alamat</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="pendudukBody"></tbody>
  </table>
</div>

<!-- Modal Form -->
<div class="modal fade" id="formModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formPenduduk">
        <div class="modal-header">
          <h5 class="modal-title">Tambah/Edit Penduduk</h5>
        </div>
        <div class="modal-body">
          <input type="hidden" id="id">
          <div class="mb-3">
            <label>Nama</label>
            <input type="text" id="nama" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>NIK</label>
            <input type="text" id="nik" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Alamat</label>
            <input type="text" id="alamat" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module">
  import { supabase } from "./supabase.js";

  const tbody = document.getElementById("pendudukBody");
  const formPenduduk = document.getElementById("formPenduduk");
  const adminActions = document.getElementById("adminActions");

  // cek user role
  const user = JSON.parse(sessionStorage.getItem("user"));
  if (!user) window.location.href = "index.html";

  // Ambil role dari tabel profile (buat dulu di Supabase)
  async function getRole() {
    let { data } = await supabase.from("profiles").select("role").eq("id", user.id).single();
    return data ? data.role : "member";
  }

  // Load data
  async function loadData(role) {
    let { data } = await supabase.from("penduduk").select("*");
    tbody.innerHTML = "";
    data.forEach(d => {
      let aksi = role === "admin" ? `
        <button class="btn btn-sm btn-warning" onclick="editPenduduk('${d.id}','${d.nama}','${d.nik}','${d.alamat}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="hapusPenduduk('${d.id}')">Hapus</button>
      ` : `-`;

      tbody.innerHTML += `
        <tr>
          <td>${d.nama}</td>
          <td>${d.nik}</td>
          <td>${d.alamat}</td>
          <td>${aksi}</td>
        </tr>`;
    });
  }

  // Tambah / Update
  formPenduduk.addEventListener("submit", async (e) => {
    e.preventDefault();
    let id = document.getElementById("id").value;
    let nama = document.getElementById("nama").value;
    let nik = document.getElementById("nik").value;
    let alamat = document.getElementById("alamat").value;

    if (id) {
      await supabase.from("penduduk").update({ nama, nik, alamat }).eq("id", id);
    } else {
      await supabase.from("penduduk").insert([{ nama, nik, alamat }]);
    }
    location.reload();
  });

  // Edit
  window.editPenduduk = (id, nama, nik, alamat) => {
    document.getElementById("id").value = id;
    document.getElementById("nama").value = nama;
    document.getElementById("nik").value = nik;
    document.getElementById("alamat").value = alamat;
    new bootstrap.Modal(document.getElementById('formModal')).show();
  };

  // Hapus
  window.hapusPenduduk = async (id) => {
    if (confirm("Yakin hapus data?")) {
      await supabase.from("penduduk").delete().eq("id", id);
      location.reload();
    }
  };

  // init
  (async () => {
    const role = await getRole();
    if (role === "admin") adminActions.style.display = "block";
    loadData(role);
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
