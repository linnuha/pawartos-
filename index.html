<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Login & Input Penduduk</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-4">Pendataan Penduduk</h2>

    <!-- LOGIN -->
    <div id="login-section" class="card p-4 shadow-sm">
      <h5 class="mb-3">Login</h5>
      <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
      <input type="password" id="loginPassword" class="form-control mb-2" placeholder="Password">
      <button class="btn btn-primary w-100" onclick="login()">Login</button>
    </div>

    <!-- FORM INPUT -->
    <div id="form-section" class="card p-4 shadow-sm d-none">
      <h5 class="mb-3">Input Data Penduduk</h5>
      <form id="pendudukForm">
        <input type="text" id="nik" class="form-control mb-2" placeholder="NIK" required>
        <input type="text" id="nama" class="form-control mb-2" placeholder="Nama" required>
        <input type="text" id="alamat" class="form-control mb-2" placeholder="Alamat" required>
        <input type="text" id="keterangan" class="form-control mb-2" placeholder="Keterangan">

        <label>Upload KK</label>
        <input type="file" id="kk" class="form-control mb-2" accept="image/*" required>
        <label>Upload Foto Diri</label>
        <input type="file" id="fotoDiri" class="form-control mb-2" accept="image/*" required>
        <label>Upload Foto Rumah</label>
        <input type="file" id="fotoRumah" class="form-control mb-2" accept="image/*" required>

        <!-- Map Tagging -->
        <label>Lokasi</label>
        <div id="map" style="height: 300px;" class="mb-2"></div>
        <input type="hidden" id="latitude">
        <input type="hidden" id="longitude">

        <button type="submit" class="btn btn-success w-100">Submit</button>
      </form>
    </div>
  </div>

  <script>
    // Supabase init
    const SUPABASE_URL = "https://qlhnigssqyrajriufwrp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsaG5pZ3NzcXlyYWpyaXVmd3JwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5Nzk3MTksImV4cCI6MjA2NzU1NTcxOX0.0V-1R0AlEaWsN_ftCIty7Ckbka8RNHuPvwu_wPWKTcA";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const GAS_URL = "https://script.google.com/macros/s/AKfycbw-Yssu1IlHunLtRXD4LbCKXvxyMJQF3DWyBFvg9wr1uyqKHWXYqEfqDTPX6ZwTr0kalw/exec";

    // Login
    async function login() {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPassword").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) {
        alert("Login gagal: " + error.message);
      } else {
        document.getElementById("login-section").classList.add("d-none");
        document.getElementById("form-section").classList.remove("d-none");
      }
    }

    // Upload file helper
    async function uploadFile(file, folder, prefix) {
      const fileName = `${folder}/${prefix}-${Date.now()}-${file.name}`;
      const { error } = await supabase.storage.from("penduduk").upload(fileName, file);
      if (error) { console.error(error); return null; }
      return `${SUPABASE_URL}/storage/v1/object/public/penduduk/${fileName}`;
    }

    // Submit form
    document.getElementById("pendudukForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const nik = document.getElementById("nik").value;
      const nama = document.getElementById("nama").value;
      const alamat = document.getElementById("alamat").value;
      const keterangan = document.getElementById("keterangan").value;
      const lat = document.getElementById("latitude").value;
      const lng = document.getElementById("longitude").value;

      const kkFile = document.getElementById("kk").files[0];
      const diriFile = document.getElementById("fotoDiri").files[0];
      const rumahFile = document.getElementById("fotoRumah").files[0];

      const kkUrl = await uploadFile(kkFile, nik, "kk");
      const diriUrl = await uploadFile(diriFile, nik, "diri");
      const rumahUrl = await uploadFile(rumahFile, nik, "rumah");

      const payload = { nik, nama, alamat, keterangan, kkUrl, diriUrl, rumahUrl, lat, lng };

      await fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      alert("Data berhasil disimpan!");
      e.target.reset();
    });

    // Leaflet Map
    let map = L.map('map').setView([-7.797068, 110.370529], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker;
    map.on("click", function(e) {
      const { lat, lng } = e.latlng;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lng;
    });
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>
