<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pendataan Penduduk - Login & Input</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="container py-5">
  <h2 class="mb-4">Login Admin / Member</h2>
  <div id="loginForm">
    <input id="email" class="form-control mb-2" placeholder="Email">
    <input id="password" type="password" class="form-control mb-2" placeholder="Password">
    <button class="btn btn-primary w-100" onclick="login()">Login</button>
  </div>

  <div id="formSection" style="display:none;">
    <h2 class="mt-5">Input Data Penduduk</h2>
    <form id="pendudukForm">
      <input class="form-control mb-2" name="nik" placeholder="NIK" required>
      <input class="form-control mb-2" name="nama" placeholder="Nama" required>
      <input class="form-control mb-2" name="alamat" placeholder="Alamat" required>
      <input class="form-control mb-2" name="keterangan" placeholder="Keterangan">

      <label class="form-label">Foto KK</label>
      <input type="file" class="form-control mb-2" id="fotoKK" accept="image/*">

      <label class="form-label">Foto Diri</label>
      <input type="file" class="form-control mb-2" id="fotoDiri" accept="image/*">

      <label class="form-label">Foto Rumah</label>
      <input type="file" class="form-control mb-2" id="fotoRumah" accept="image/*">

      <label class="form-label">Lokasi Rumah</label>
      <input type="text" class="form-control mb-2" id="lokasi" placeholder="Lat,Lng">

      <button type="submit" class="btn btn-success w-100">Submit</button>
    </form>
  </div>

<script>
const SUPABASE_URL = "https://qlhnigssqyrajriufwrp.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsaG5pZ3NzcXlyYWpyaXVmd3JwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTk3OTcxOSwiZXhwIjoyMDY3NTU1NzE5fQ.orLku6OpgoOWshiZ9SweZdNTTbiRgnf1katQnCdBCKw"; // gunakan service_role untuk insert
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// LOGIN
async function login(){
  let {data, error} = await supabase.auth.signInWithPassword({
    email: document.getElementById('email').value,
    password: document.getElementById('password').value
  });
  if(error){ alert("Login gagal: "+error.message); return; }
  document.getElementById("loginForm").style.display="none";
  document.getElementById("formSection").style.display="block";
}

// UPLOAD FILE â†’ return public URL
async function uploadFile(bucket, file, path){
  if(!file) return null;
  const {data, error} = await supabase.storage.from(bucket)
    .upload(path, file, { upsert:true });
  if(error){ console.error(error); return null; }
  return `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${path}`;
}

// SUBMIT FORM
document.getElementById("pendudukForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const form = e.target;
  const nik = form.nik.value;
  const folder = "penduduk/"+nik;

  const urlKK = await uploadFile("penduduk", document.getElementById("fotoKK").files[0], `${folder}/kk-${Date.now()}.jpg`);
  const urlDiri = await uploadFile("penduduk", document.getElementById("fotoDiri").files[0], `${folder}/diri-${Date.now()}.jpg`);
  const urlRumah = await uploadFile("penduduk", document.getElementById("fotoRumah").files[0], `${folder}/rumah-${Date.now()}.jpg`);

  const {error} = await supabase.from("penduduk").insert([{
    nik, nama: form.nama.value, alamat: form.alamat.value,
    keterangan: form.keterangan.value, lokasi: document.getElementById("lokasi").value,
    foto_kk: urlKK, foto_diri: urlDiri, foto_rumah: urlRumah
  }]);

  if(error){ alert("Gagal simpan: "+error.message); }
  else { alert("Data berhasil disimpan!"); form.reset(); }
});
</script>
</body>
</html>
