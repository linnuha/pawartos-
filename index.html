<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Penduduk Supabase Fix</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
#map { height: 300px; width: 100%; }
img.preview { width:50px; height:50px; object-fit:cover; margin-right:5px; }
</style>
</head>
<body class="p-3">
<h2>Data Penduduk</h2>

<!-- Login -->
<div id="loginDiv" class="mb-3">
  <input id="username" placeholder="Username" class="form-control mb-1">
  <input id="password" type="password" placeholder="Password" class="form-control mb-1">
  <button id="loginBtn" class="btn btn-primary">Login</button>
</div>

<!-- Form Input -->
<div id="formDiv" style="display:none;">
  <div class="mb-2"><input id="nik" placeholder="NIK" class="form-control"></div>
  <div class="mb-2"><input id="nama" placeholder="Nama" class="form-control"></div>
  <div class="mb-2"><input id="alamat" placeholder="Alamat" class="form-control"></div>
  <div class="mb-2"><input id="nohp" placeholder="No HP" class="form-control"></div>
  <div class="mb-2">
    Foto KK: <input type="file" id="fotoKK"><br>
    Foto Diri: <input type="file" id="fotoDiri"><br>
    Foto Depan Rumah: <input type="file" id="fotoDepanRumah">
  </div>
  <div class="mb-2"><textarea id="keterangan" placeholder="Keterangan" class="form-control"></textarea></div>
  <div id="map"></div>
  <button id="submitBtn" class="btn btn-success mt-2">Submit</button>
</div>

<hr>
<button id="exportBtn" class="btn btn-secondary mb-2" style="display:none;">Export CSV/Excel</button>
<table class="table table-bordered" id="dataTable">
  <thead>
    <tr>
      <th>No</th><th>NIK</th><th>Nama</th><th>Alamat</th><th>No HP</th>
      <th>Foto KK</th><th>Foto Diri</th><th>Foto Depan Rumah</th>
      <th>Lokasi</th><th>Keterangan</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ==== Supabase Setup (deklarasi pertama!) ====
const SUPABASE_URL = "https://qlhnigssqyrajriufwrp.supabase.co"; // ganti
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsaG5pZ3NzcXlyYWpyaXVmd3JwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5Nzk3MTksImV4cCI6MjA2NzU1NTcxOX0.0V-1R0AlEaWsN_ftCIty7Ckbka8RNHuPvwu_wPWKTcA";          // ganti
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ==== Global Role ====
let role = '';

// ==== Login ====
document.getElementById("loginBtn").onclick = async ()=>{
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const { data, error } = await supabase.from('users').select('*').eq('username',username).eq('password',password).single();
  if(error || !data){ alert("Login gagal"); return; }
  role = data.role;
  document.getElementById("loginDiv").style.display="none";
  document.getElementById("formDiv").style.display=(role==='admin')?"block":"none";
  document.getElementById("exportBtn").style.display=(role==='admin')?"inline-block":"none";
  loadData();
};

// ==== Map ====
let map = L.map('map').setView([-6.2,106.8], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker = null;
map.on('click', e=>{
  if(marker) map.removeLayer(marker);
  marker = L.marker(e.latlng).addTo(map);
});

// ==== Upload Foto ====
async function uploadFile(file, folder){
  if(!file) return "";
  const { data, error } = await supabase.storage.from('uploads').upload(`${folder}/${Date.now()}_${file.name}`, file);
  if(error) throw error;
  const { publicUrl } = supabase.storage.from('uploads').getPublicUrl(data.path);
  return publicUrl;
}

// ==== Submit Form ====
document.getElementById("submitBtn").onclick = async ()=>{
  const nik=document.getElementById("nik").value;
  const nama=document.getElementById("nama").value;
  const alamat=document.getElementById("alamat").value;
  const nohp=document.getElementById("nohp").value;
  const keterangan=document.getElementById("keterangan").value;
  const lokasi = marker? `${marker.getLatLng().lat},${marker.getLatLng().lng}` : "";
  const fotoKK = await uploadFile(document.getElementById("fotoKK").files[0], "fotoKK");
  const fotoDiri = await uploadFile(document.getElementById("fotoDiri").files[0], "fotoDiri");
  const fotoDepanRumah = await uploadFile(document.getElementById("fotoDepanRumah").files[0], "fotoDepanRumah");

  const { data, error } = await supabase.from('penduduk').insert([{
    nik,nama,alamat,nohp,fotoKK,fotoDiri,fotoDepanRumah,lokasi,keterangan
  }]);
  if(error) alert(error.message);
  else { alert("Data tersimpan"); loadData(); }
};

// ==== Load Data ====
async function loadData(){
  const { data, error } = await supabase.from('penduduk').select('*').order('id',{ascending:true});
  if(error) return alert(error.message);
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  data.forEach((d,i)=>{
    tbody.innerHTML += `<tr>
      <td>${i+1}</td><td>${d.nik}</td><td>${d.nama}</td><td>${d.alamat}</td><td>${d.nohp}</td>
      <td>${d.fotoKK?`<img src="${d.fotoKK}" class="preview">`:""}</td>
      <td>${d.fotoDiri?`<img src="${d.fotoDiri}" class="preview">`:""}</td>
      <td>${d.fotoDepanRumah?`<img src="${d.fotoDepanRumah}" class="preview">`:""}</td>
      <td>${d.lokasi}</td><td>${d.keterangan}</td>
      <td>${role==='admin'?`<button onclick="deleteData(${d.id})" class="btn btn-sm btn-danger">Delete</button>`:""}</td>
    </tr>`;
  });
}

// ==== Delete Data ====
async function deleteData(id){
  if(!confirm("Hapus data ini?")) return;
  const { error } = await supabase.from('penduduk').delete().eq('id',id);
  if(error) alert(error.message);
  else loadData();
}

// ==== Export Excel/CSV ====
document.getElementById("exportBtn").onclick = async ()=>{
  const { data, error } = await supabase.from('penduduk').select('*');
  if(error) return alert(error.message);
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Penduduk");
  XLSX.writeFile(wb, "data_penduduk.xlsx");
};
</script>
</body>
</html>
