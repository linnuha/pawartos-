<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pendataan Penduduk</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>#map{height:300px;}</style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div id="loginSection">
    <h3>Login</h3>
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" class="form-control mb-2" required>
      <input type="password" id="password" placeholder="Password" class="form-control mb-2" required>
      <button type="submit" class="btn btn-primary">Login</button>
    </form>
  </div>

  <div id="formSection" class="hidden">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Input Data Penduduk</h3>
      <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
    </div>
    <form id="pendudukForm" class="row g-3">
      <div class="col-md-6"><label>NIK</label><input type="text" id="nik" class="form-control" required></div>
      <div class="col-md-6"><label>Nama</label><input type="text" id="nama" class="form-control" required></div>
      <div class="col-md-6"><label>Nomor HP</label><input type="text" id="no_hp" class="form-control" required></div>
      <div class="col-md-6"><label>Alamat</label><input type="text" id="alamat" class="form-control" required></div>
      <div class="col-12"><label>Keterangan</label><textarea id="keterangan" class="form-control"></textarea></div>
      <div class="col-md-4"><label>Foto KK</label><input type="file" id="foto_kk" class="form-control" accept="image/*" required></div>
      <div class="col-md-4"><label>Foto Diri</label><input type="file" id="foto_diri" class="form-control" accept="image/*" required></div>
      <div class="col-md-4"><label>Foto Rumah</label><input type="file" id="foto_rumah" class="form-control" accept="image/*" required></div>
      <div class="col-12">
        <label>Pilih Lokasi</label>
        <div id="map"></div>
        <input type="hidden" id="latitude">
        <input type="hidden" id="longitude">
      </div>
      <div class="col-12"><button class="btn btn-success">Simpan Data</button></div>
    </form>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  const SUPABASE_URL = "https://qlhnigssqyrajriufwrp.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsaG5pZ3NzcXlyYWpyaXVmd3JwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5Nzk3MTksImV4cCI6MjA2NzU1NTcxOX0.0V-1R0AlEaWsN_ftCIty7Ckbka8RNHuPvwu_wPWKTcA";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const loginSection = document.getElementById("loginSection");
  const formSection = document.getElementById("formSection");
  const loginForm = document.getElementById("loginForm");
  const pendudukForm = document.getElementById("pendudukForm");
  const logoutBtn = document.getElementById("logoutBtn");
  let currentUser = null;

  loginForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { data, error } = await supabase.from("users")
      .select("*").eq("email",email).eq("password",password).single();
    if(error || !data){alert("Email/password salah"); return;}
    currentUser = data;
    sessionStorage.setItem("user", JSON.stringify(currentUser));
    loginSection.classList.add("hidden");
    formSection.classList.remove("hidden");
  });

  logoutBtn.addEventListener("click",()=>{
    sessionStorage.removeItem("user");
    location.reload();
  });

  // Map
  const map = L.map("map").setView([-7.8014,110.3644],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(map);
  let marker;
  map.on("click",e=>{
    if(marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map);
    document.getElementById("latitude").value = e.latlng.lat;
    document.getElementById("longitude").value = e.latlng.lng;
  });

  async function uploadFile(file, folder, nik){
    const path = `${nik}/${folder}-${Date.now()}-${file.name}`;
    const { error } = await supabase.storage.from("penduduk").upload(path, file, { upsert:true });
    if(error){ console.error(error); alert("Gagal upload "+folder); return null;}
    const { data } = supabase.storage.from("penduduk").getPublicUrl(path);
    return data.publicUrl;
  }

  pendudukForm.addEventListener("submit", async e=>{
    e.preventDefault();
    if(!currentUser || currentUser.role!=="admin"){alert("Hanya admin bisa input"); return;}
    try{
      const nik = document.getElementById("nik").value;
      const nama = document.getElementById("nama").value;
      const no_hp = document.getElementById("no_hp").value;
      const alamat = document.getElementById("alamat").value;
      const keterangan = document.getElementById("keterangan").value;
      const lat = document.getElementById("latitude").value;
      const lng = document.getElementById("longitude").value;

      const fotoKK = await uploadFile(document.getElementById("foto_kk").files[0],"kk",nik);
      const fotoDiri = await uploadFile(document.getElementById("foto_diri").files[0],"diri",nik);
      const fotoRumah = await uploadFile(document.getElementById("foto_rumah").files[0],"rumah",nik);

      if(!fotoKK||!fotoDiri||!fotoRumah) return;

      const { error } = await supabase.from("penduduk").insert([{
        nik,nama,no_hp,alamat,keterangan,latitude:lat,longitude:lng,
        foto_kk:fotoKK,foto_diri:fotoDiri,foto_rumah:fotoRumah
      }]);
      if(error) throw error;
      alert("Data tersimpan!");
      pendudukForm.reset();
      if(marker) map.removeLayer(marker);
    }catch(err){console.error(err); alert("Gagal simpan");}
  });
});
</script>

</body>
</html>
