<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Penduduk</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
.preview-img { max-width: 100px; margin-top: 5px; }
#map, #editMap { height: 300px; }
th { cursor: pointer; }
</style>
</head>
<body class="container py-4">

<!-- Modal Login -->
<div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Login</h5></div>
      <div class="modal-body">
        <form id="loginForm">
          <div class="mb-3"><label>Username</label><input type="text" id="username" class="form-control" required></div>
          <div class="mb-3"><label>Password</label><input type="password" id="password" class="form-control" required></div>
          <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
      </div>
    </div>
  </div>
</div>

<h2 class="mb-4">Form Input Data Penduduk</h2>
<form id="dataForm" class="row g-3">
  <div class="col-md-6"><label class="form-label">NIK</label><input type="text" id="nik" class="form-control" required></div>
  <div class="col-md-6"><label class="form-label">Nama</label><input type="text" id="nama" class="form-control" required></div>
  <div class="col-12"><label class="form-label">Alamat</label><input type="text" id="alamat" class="form-control" required></div>
  <div class="col-md-6"><label class="form-label">Nomor HP</label><input type="text" id="nohp" class="form-control" required></div>
  <div class="col-md-4"><label class="form-label">Foto KK</label><input type="file" id="fotoKK" accept="image/*" class="form-control"><div id="previewFotoKK"></div></div>
  <div class="col-md-4"><label class="form-label">Foto Diri</label><input type="file" id="fotoDiri" accept="image/*" class="form-control"><div id="previewFotoDiri"></div></div>
  <div class="col-md-4"><label class="form-label">Foto Depan Rumah (opsional)</label><input type="file" id="fotoDepanRumah" accept="image/*" class="form-control"><div id="previewFotoDepanRumah"></div></div>
  <div class="col-12"><label class="form-label">Pilih Lokasi di Peta</label><div id="map"></div><input type="hidden" id="lokasi"></div>
  <div class="col-12"><label class="form-label">Keterangan</label><textarea id="keterangan" class="form-control"></textarea></div>
  <div class="col-12"><button type="submit" class="btn btn-primary">Simpan</button></div>
</form>

<hr>
<h3>Daftar Data Penduduk</h3>
<div class="mb-2"><input type="text" id="searchInput" class="form-control" placeholder="Cari data..."></div>
<div class="mb-3">
  <button class="btn btn-success btn-sm" id="exportCSV">Export CSV</button>
  <button class="btn btn-success btn-sm" id="exportExcel">Export Excel</button>
</div>
<table class="table table-bordered table-striped" id="dataTable">
  <thead>
    <tr>
      <th>No</th>
      <th>NIK</th>
      <th>Nama</th>
      <th>Alamat</th>
      <th>No HP</th>
      <th>Foto KK</th>
      <th>Foto Diri</th>
      <th>Foto Depan Rumah</th>
      <th>Lokasi</th>
      <th>Keterangan</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal Edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Data</h5></div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <input type="hidden" id="editId">
          <div class="col-md-6"><label class="form-label">NIK</label><input type="text" id="editNIK" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nama</label><input type="text" id="editNama" class="form-control" required></div>
          <div class="col-12"><label class="form-label">Alamat</label><input type="text" id="editAlamat" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nomor HP</label><input type="text" id="editNohp" class="form-control" required></div>
          <div class="col-md-4"><label class="form-label">Foto KK</label><input type="file" id="editFotoKK" accept="image/*" class="form-control"><div id="editPreviewFotoKK"></div></div>
          <div class="col-md-4"><label class="form-label">Foto Diri</label><input type="file" id="editFotoDiri" accept="image/*" class="form-control"><div id="editPreviewFotoDiri"></div></div>
          <div class="col-md-4"><label class="form-label">Foto Depan Rumah</label><input type="file" id="editFotoDepanRumah" accept="image/*" class="form-control"><div id="editPreviewFotoDepanRumah"></div></div>
          <div class="col-12"><label class="form-label">Pilih Lokasi di Peta</label><div id="editMap"></div><input type="hidden" id="editLokasi"></div>
          <div class="col-12"><label class="form-label">Keterangan</label><textarea id="editKeterangan" class="form-control"></textarea></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="saveEdit">Simpan Perubahan</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let token = "";
let role = "";
let map, marker, editMap, editMarker;

// login
const loginModal = new bootstrap.Modal(document.getElementById("loginModal"));
loginModal.show();
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const res = await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
  const data = await res.json();
  if(data.token){ token = data.token; role = data.role; loginModal.hide(); initApp(); } 
  else alert(data.error);
});

// init
function initApp(){
  if(role==="member") document.getElementById("dataForm").style.display="none";
  initMap();
  loadData();
}

// map
function initMap(){
  map = L.map('map').setView([-6.2,106.8],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  map.on('click', e=>{
    if(marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map);
    document.getElementById("lokasi").value = e.latlng.lat+','+e.latlng.lng;
  });
}

// preview
function previewImage(input, previewId){
  const file = input.files[0]; const previewDiv = document.getElementById(previewId);
  previewDiv.innerHTML="";
  if(file){ const reader = new FileReader(); reader.onload=e=>{ const img=document.createElement("img"); img.src=e.target.result; img.className="preview-img"; previewDiv.appendChild(img); }; reader.readAsDataURL(file);}
}
["fotoKK","fotoDiri","fotoDepanRumah"].forEach(id=>{
  document.getElementById(id).addEventListener("change",()=>previewImage(document.getElementById(id), "preview"+id));
});

// tambah data
document.getElementById("dataForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const form = new FormData();
  form.append("nik", document.getElementById("nik").value);
  form.append("nama", document.getElementById("nama").value);
  form.append("alamat", document.getElementById("alamat").value);
  form.append("nohp", document.getElementById("nohp").value);
  form.append("lokasi", document.getElementById("lokasi").value);
  form.append("keterangan", document.getElementById("keterangan").value);
  ["fotoKK","fotoDiri","fotoDepanRumah"].forEach(id=>{
    if(document.getElementById(id).files[0]) form.append(id, document.getElementById(id).files[0]);
  });
  const res = await fetch("/api/penduduk",{method:"POST",headers:{"Authorization":"Bearer "+token},body:form});
  const data = await res.json();
  if(data.id){ alert("Data tersimpan"); e.target.reset(); loadData(); }
  else alert(data.error);
});

// load data
async function loadData(){
  const res = await fetch("/api/penduduk",{headers:{"Authorization":"Bearer "+token}});
  const penduduk = await res.json();
  const tbody = document.querySelector("#dataTable tbody"); tbody.innerHTML="";
  penduduk.forEach((p,i)=>{
    const row = tbody.insertRow();
    row.innerHTML=`
      <td>${i+1}</td>
      <td>${p.nik}</td>
      <td>${p.nama}</td>
      <td>${p.alamat}</td>
      <td>${p.nohp}</td>
      <td>${p.fotoKK?'<img src="/uploads/'+p.fotoKK+'" class="preview-img">':''}</td>
      <td>${p.fotoDiri?'<img src="/uploads/'+p.fotoDiri+'" class="preview-img">':''}</td>
      <td>${p.fotoDepanRumah?'<img src="/uploads/'+p.fotoDepanRumah+'" class="preview-img">':''}</td>
      <td>${p.lokasi?'<a href="https://www.google.com/maps?q='+p.lokasi+'" target="_blank">Lihat</a>':''}</td>
      <td>${p.keterangan}</td>
      <td>${role==="admin"?`<button class="btn btn-warning btn-sm" onclick="editData(${p.id})">Edit</button>
      <button class="btn btn-danger btn-sm" onclick="deleteData(${p.id})">Hapus</button>`:"-"}</td>
    `;
  });
}

// edit
async function editData(id){
  const res = await fetch("/api/penduduk",{headers:{"Authorization":"Bearer "+token}});
  const penduduk = await res.json();
  const p = penduduk.find(x=>x.id===id);
  document.getElementById("editId").value=id;
  document.getElementById("editNIK").value=p.nik;
  document.getElementById("editNama").value=p.nama;
  document.getElementById("editAlamat").value=p.alamat;
  document.getElementById("editNohp").value=p.nohp;
  document.getElementById("editKeterangan").value=p.keterangan;
  document.getElementById("editLokasi").value=p.lokasi;

  // preview
  ["editFotoKK","editFotoDiri","editFotoDepanRumah"].forEach(idf=>{
    const key = idf.replace("edit","");
    const url = p[key]?"/uploads/"+p[key]:"";
    document.getElementById(idf.replace("edit","editPreview"+key)).innerHTML=url?`<img src="${url}" class="preview-img">`:"";
  });

  // map
  if(editMap) editMap.remove();
  editMap = L.map('editMap').setView(p.lokasi?p.lokasi.split(","):[-6.2,106.8],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(editMap);
  if(p.lokasi){ editMarker = L.marker(p.lokasi.split(",")).addTo(editMap);}
  editMap.on('click', e=>{ if(editMarker) editMap.removeLayer(editMarker); editMarker=L.marker(e.latlng).addTo(editMap); document.getElementById("editLokasi").value=e.latlng.lat+','+e.latlng.lng; });
  new bootstrap.Modal(document.getElementById('editModal')).show();
}

// preview edit image
["editFotoKK","editFotoDiri","editFotoDepanRumah"].forEach(id=>{
  document.getElementById(id).addEventListener("change",()=>previewImage(document.getElementById(id), id.replace("edit","editPreview")));
});

// save edit
document.getElementById("saveEdit").addEventListener("click", async()=>{
  const form = new FormData();
  const id = document.getElementById("editId").value;
  form.append("nik", document.getElementById("editNIK").value);
  form.append("nama", document.getElementById("editNama").value);
  form.append("alamat", document.getElementById("editAlamat").value);
  form.append("nohp", document.getElementById("editNohp").value);
  form.append("lokasi", document.getElementById("editLokasi").value);
  form.append("keterangan", document.getElementById("editKeterangan").value);
  ["editFotoKK","editFotoDiri","editFotoDepanRumah"].forEach(idf=>{
    if(document.getElementById(idf).files[0]) form.append(idf.replace("edit",""), document.getElementById(idf).files[0]);
  });
  const res = await fetch("/api/penduduk/"+id,{method:"PUT",headers:{"Authorization":"Bearer "+token},body:form});
  const data = await res.json(); if(data.success){ alert("Berhasil"); loadData(); bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();}
  else alert(data.error);
});

// delete
async function deleteData(id){ if(confirm("Hapus data ini?")){ const res = await fetch("/api/penduduk/"+id,{method:"DELETE",headers:{"Authorization":"Bearer "+token}}); const data = await res.json(); if(data.success){loadData();} else alert(data.error);}}

// search
document.getElementById("searchInput").addEventListener("input", function(){
  const v=this.value.toLowerCase();
  document.querySelectorAll("#dataTable tbody tr").forEach(tr=>{tr.style.display=Array.from(tr.cells).some(td=>td.textContent.toLowerCase().includes(v))?"":"none";});
});

// export CSV
document.getElementById("exportCSV").addEventListener("click", ()=>{ window.open("/api/penduduk","_blank"); });

// export Excel
document.getElementById("exportExcel").addEventListener("click", ()=>{ window.open("/api/export","_blank"); });
</script>
</body>
</html>
